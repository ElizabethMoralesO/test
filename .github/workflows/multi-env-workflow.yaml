name: Multi-Environment Pipeline

on:
    workflow_dispatch:
        inputs:
            release_version:
                description: "Release version (e.g., v1.0.0)"
                required: true
            source_environment:
                description: "Source environment"
                required: true
                type: choice
                options:
                    - development
                    - staging
                    - production
            target_environments:
                description: "Target environments (comma-separated: qa,staging,production)"
                required: true
                default: "qa"
            approval_required:
                description: "Require manual approval for production"
                type: boolean
                default: true
            rollback_strategy:
                description: "Rollback strategy"
                type: choice
                default: "automatic"
                options:
                    - automatic
                    - manual
                    - none

env:
    RELEASE_VERSION: ${{ github.event.inputs.release_version }}
    SOURCE_ENV: ${{ github.event.inputs.source_environment }}
    ROLLBACK_STRATEGY: ${{ github.event.inputs.rollback_strategy }}

jobs:
    validate-inputs:
        runs-on: ubuntu-latest
        outputs:
            target_matrix: ${{ steps.parse.outputs.matrix }}
            requires_approval: ${{ steps.check.outputs.needs_approval }}

        steps:
            - name: ğŸ“‹ Parse Target Environments
              id: parse
              run: |
                  # Convert comma-separated string to JSON array
                  TARGETS="${{ github.event.inputs.target_environments }}"
                  echo "Raw targets: $TARGETS"

                  # Create JSON matrix
                  MATRIX=$(echo "$TARGETS" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
                  echo "Matrix: $MATRIX"
                  echo "matrix={\"environment\":$MATRIX}" >> $GITHUB_OUTPUT

            - name: ğŸ” Check Approval Requirements
              id: check
              run: |
                  TARGETS="${{ github.event.inputs.target_environments }}"
                  APPROVAL_REQUIRED="${{ github.event.inputs.approval_required }}"

                  if [[ "$TARGETS" == *"production"* && "$APPROVAL_REQUIRED" == "true" ]]; then
                    echo "needs_approval=true" >> $GITHUB_OUTPUT
                    echo "ğŸ”’ Production deployment requires manual approval"
                  else
                    echo "needs_approval=false" >> $GITHUB_OUTPUT
                    echo "âœ… No approval required for this deployment"
                  fi

    deploy:
        needs: validate-inputs
        runs-on: ubuntu-latest
        strategy:
            matrix: ${{ fromJson(needs.validate-inputs.outputs.target_matrix) }}
            fail-fast: false

        environment:
            name: ${{ matrix.environment }}
            url: https://${{ matrix.environment }}.example.com

        steps:
            - name: ğŸš€ Deploy to ${{ matrix.environment }}
              run: |
                  echo "ğŸ¯ Starting deployment to ${{ matrix.environment }}"
                  echo "ğŸ“¦ Version: ${{ env.RELEASE_VERSION }}"
                  echo "ğŸ”„ Source: ${{ env.SOURCE_ENV }}"
                  echo "âš–ï¸ Rollback Strategy: ${{ env.ROLLBACK_STRATEGY }}"

                  # Simulate deployment process
                  echo "ğŸ“¥ Pulling artifacts from ${{ env.SOURCE_ENV }}..."
                  sleep 2

                  echo "ğŸ”§ Configuring ${{ matrix.environment }} environment..."
                  sleep 1

                  echo "ğŸš€ Deploying version ${{ env.RELEASE_VERSION }}..."
                  sleep 3

                  echo "âœ… Deployment to ${{ matrix.environment }} completed successfully!"

            - name: ğŸ” Health Check
              run: |
                  echo "ğŸ¥ Running health checks for ${{ matrix.environment }}..."

                  # Simulate health check
                  if [ "${{ matrix.environment }}" = "production" ]; then
                    echo "ğŸ” Extended health check for production..."
                    sleep 5
                  else
                    sleep 2
                  fi

                  echo "âœ… Health check passed for ${{ matrix.environment }}"

            - name: ğŸ“Š Update Deployment Status
              run: |
                  echo "ğŸ“Š Updating deployment status..."
                  echo "Environment: ${{ matrix.environment }}"
                  echo "Version: ${{ env.RELEASE_VERSION }}"
                  echo "Status: âœ… Deployed"
                  echo "Timestamp: $(date)"

    notification:
        needs: [validate-inputs, deploy]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: ğŸ“§ Send Deployment Summary
              run: |
                  echo "ğŸ“§ Sending deployment summary notification..."
                  echo ""
                  echo "ğŸš€ Multi-Environment Pipeline Summary"
                  echo "====================================="
                  echo "ğŸ“¦ Release: ${{ env.RELEASE_VERSION }}"
                  echo "ğŸ”„ Source: ${{ env.SOURCE_ENV }}"
                  echo "ğŸ¯ Targets: ${{ github.event.inputs.target_environments }}"
                  echo "âš–ï¸ Rollback: ${{ env.ROLLBACK_STRATEGY }}"
                  echo "ğŸ”’ Approval Required: ${{ github.event.inputs.approval_required }}"
                  echo ""

                  if [ "${{ needs.deploy.result }}" = "success" ]; then
                    echo "âœ… All deployments completed successfully!"
                  else
                    echo "âŒ Some deployments failed. Check logs for details."
                  fi
