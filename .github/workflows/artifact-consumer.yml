name: Deploy - Consume Artifact

run-name: "Deploy '${{ inputs.source_workflow }}' | ${{ inputs.download_mode == 'run_id' && format('Run #{0}', inputs.ref) || format('branch: {0}', inputs.ref) }}"

on:
  workflow_dispatch:
    inputs:
      source_workflow:
        description: 'Source workflow'
        required: true
        type: choice
        options:
          - 'Build and Upload Artifact'
      download_mode:
        description: 'Download by run ID or latest from branch'
        required: true
        type: choice
        default: 'run_id'
        options:
          - 'run_id'
          - 'branch'
      ref:
        description: 'Run ID (e.g. 1234567890) or branch name (e.g. main) — depending on mode above'
        required: true
        type: string

env:
  ARTIFACT_NAME: 'my-artifact'

jobs:
  consume-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.ref }}" ]; then
            echo "::error::ref is required"
            exit 1
          fi

      # Map workflow display name → filename
      # Add new entries here as you onboard more producer workflows
      - name: Resolve workflow filename from display name
        id: map
        run: |
          case "${{ inputs.source_workflow }}" in
            "Build and Upload Artifact")
              WORKFLOW_FILE="artifact-producer.yml" ;;
            *)
              echo "::error::Unknown workflow name: '${{ inputs.source_workflow }}'"
              exit 1 ;;
          esac
          echo "Resolved filename: $WORKFLOW_FILE"
          echo "workflow_file=$WORKFLOW_FILE" >> $GITHUB_OUTPUT

      # When mode=branch: resolve the latest successful run ID on that branch
      - name: Resolve latest run ID from branch
        if: inputs.download_mode == 'branch'
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Looking for latest successful run of '${{ steps.map.outputs.workflow_file }}' on branch '${{ inputs.ref }}'..."

          RESOLVED_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow="${{ steps.map.outputs.workflow_file }}" \
            --branch="${{ inputs.ref }}" \
            --status=success \
            --limit=1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RESOLVED_ID" ] || [ "$RESOLVED_ID" == "null" ]; then
            echo "::error::No successful run found for '${{ inputs.source_workflow }}' on branch '${{ inputs.ref }}'"
            exit 1
          fi

          echo "Resolved Run ID: $RESOLVED_ID"
          echo "resolved_run_id=$RESOLVED_ID" >> $GITHUB_OUTPUT

      # Determine the effective run ID to use downstream
      - name: Set effective run ID
        id: effective
        run: |
          if [ "${{ inputs.download_mode }}" == "branch" ]; then
            echo "run_id=${{ steps.resolve.outputs.resolved_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "run_id=${{ inputs.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### Artifact Download Info" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Source Workflow | ${{ inputs.source_workflow }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow File | ${{ steps.map.outputs.workflow_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Download Mode | ${{ inputs.download_mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ref (input) | ${{ inputs.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Effective Run ID | ${{ steps.effective.outputs.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact Name | ${{ env.ARTIFACT_NAME }} |" >> $GITHUB_STEP_SUMMARY

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ${{ steps.map.outputs.workflow_file }}
          run_id: ${{ steps.effective.outputs.run_id }}
          name: ${{ env.ARTIFACT_NAME }}
          path: ./downloaded-artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find ./downloaded-artifacts -type f

      - name: Display artifact content
        run: cat ./downloaded-artifacts/artifact.txt || echo "File not found"

      - name: Deploy
        run: |
          echo "Deploying artifact from run ${{ steps.effective.outputs.run_id }}..."
          # Add your deployment logic here